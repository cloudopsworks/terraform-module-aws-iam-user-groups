name: "AWS IAM Users, Groups, and Policies Module"
#logo: logo/logo.jpg

license: "APACHE2"

copyrights:
  - name: "Cloud Ops Works LLC"
    url: "https://cloudops.works"
    year: "2025"

github_repo: cloudopsworks/terraform-module-aws-iam-user-groups

description: |-
  A comprehensive Terragrunt-ready module to manage AWS IAM identities and permissions at scale. It facilitates the creation of IAM users, groups, and policies with support for secret storage in AWS Secrets Manager and PGP encryption.

introduction: |-
  This module provides a standardized way to manage IAM Users, Groups, and Policies across multiple AWS accounts and environments. It integrates seamlessly with Terragrunt for infrastructure-as-code management. Key features include:
  - **IAM User Management**: Create users with console access, programmatic access keys, and CodeCommit credentials.
  - **IAM Group Management**: Define groups with explicit names or prefixes, attach AWS managed policies, module-defined policies, or inline policies.
  - **IAM Policy Management**: Define reusable policies that can be referenced by multiple groups.
  - **Secret Management**: Automatically store generated console passwords and access keys in AWS Secrets Manager.
  - **Security**: Support for PGP encryption for sensitive outputs, including loading keys from Secrets Manager.

usage: |-
  To use this module with Terragrunt, include it in your `terragrunt.hcl` file.

  ### Terragrunt Configuration
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-iam-user-groups.git?ref=v1.0.0"
  }

  inputs = {
    org = {
      organization_name = "acme"
      organization_unit = "platform"
      environment_type  = "prod"
      environment_name  = "main"
    }

    spoke_def = "001"
    is_hub    = false

    extra_tags = {
      Project = "IAM-Management"
    }

    secrets_manager_store = true
    default_pgp_key       = "_aws:prod/shared/pgp/public"

    policies = [
      {
        name = "S3ReadOnly"
        statements = [
          {
            effect    = "Allow"
            actions   = ["s3:Get*", "s3:List*"]
            resources = ["*"]
          }
        ]
      }
    ]

    groups = [
      {
        name        = "developers"
        policy_refs = ["S3ReadOnly"]
      }
    ]

    users = [
      {
        name   = "john.doe"
        groups = ["developers"]
        console_access = {
          enabled = true
        }
      }
    ]
  }
  ```

  ### Variables Documentation (YAML Format)
  ```yaml
  # Organization definition
  org:
    organization_name: "acme" # (Required) Name of the organization
    organization_unit: "platform" # (Required) Name of the organizational unit
    environment_type: "prod" # (Required) Type of environment (e.g., prod, dev, staging)
    environment_name: "main" # (Required) Name of the environment

  # Spoke definition
  spoke_def: "001" # (Optional) Spoke definition identifier. Default: "001"

  # Hub/Spoke configuration
  is_hub: false # (Optional) Establish if this is a HUB or spoke configuration. Default: false

  # Extra tags
  extra_tags: {} # (Optional) Additional tags to be applied to all resources. Default: {}

  # Global settings
  secrets_manager_store: false # (Optional) When true, the module saves generated secrets into AWS Secrets Manager. Default: false
  default_pgp_key: "" # (Optional) Default PGP key used to encrypt sensitive values. Default: ""

  # Users configuration
  users:
    - name: "username" # (Required) IAM user name
      path: "/" # (Optional) IAM path (e.g., "/service/"). Default: "/"
      pgp_key: "armored_pgp_key" # (Optional) PGP key for this user. Default: ""
      groups: ["group1"] # (Optional) List of groups the user belongs to. Default: []
      access_keys: # (Optional) List of access keys to create. Default: []
        - name: "key1" # (Required) Logical name for the key
          status: "Active" # (Optional) Status of the key. Possible values: "Active", "Inactive". Default: "Active"
      console_access: # (Optional) AWS Console access configuration. Default: null
        enabled: true # (Required) When true, create login profile
        password_length: 20 # (Optional) Password length. Default: 20
        password_reset_required: true # (Optional) Whether password reset is required. Default: true
      code_commit: # (Optional) AWS CodeCommit credentials. Default: null
        http_credentials: true # (Optional) Create HTTP credentials. Default: false
        ssh_credentials: true # (Optional) Create SSH credentials. Default: false

  # Groups configuration
  groups:
    - name: "groupname" # (Optional) Named group (explicit name). Either name or name_prefix is REQUIRED.
      path: "/" # (Optional) IAM path. Default: "/"
      existing: false # (Optional) If true, reference existing IAM group by name. Default: false
      policy_attachments: ["arn:aws:iam::aws:policy/ReadOnlyAccess"] # (Optional) Attach existing AWS managed policies by ARN. Default: []
      policy_refs: ["policy1"] # (Optional) Attach policies created by this module via var.policies. Default: []
      inline_policies: # (Optional) Inline policies to create and attach to this group. Default: []
        - name: "inline-policy" # (Required) Name of the inline policy
          statements: # (Required) List of policy statements
            - sid: "sid1" # (Optional) Statement ID
              effect: "Allow" # (Required) Effect. Possible values: "Allow", "Deny"
              actions: ["s3:ListBucket"] # (Required) List of actions
              resources: ["arn:aws:s3:::bucket-name"] # (Required) List of resources
              conditions: # (Optional) List of conditions. Default: []
                - test: "StringEquals" # (Required) Condition test
                  variable: "aws:PrincipalTag/Department" # (Required) Condition variable
                  values: ["IT"] # (Required) Condition values

  # Policies configuration
  policies:
    - name: "policyname" # (Optional) Named policy. Either name or name_prefix is REQUIRED.
      statements: # (Required) List of policy statements
        - sid: "sid1" # (Optional) Statement ID
          effect: "Allow" # (Required) Effect. Possible values: "Allow", "Deny"
          actions: ["s3:ListBucket"] # (Required) List of actions
          resources: ["arn:aws:s3:::bucket-name"] # (Required) List of resources
  ```

examples: |-
  ### Full Terragrunt Example
  ```hcl
  include "root" {
    path = find_in_parent_folders()
  }

  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-iam-user-groups.git?ref=v1.0.0"
  }

  inputs = {
    org = {
      organization_name = "cloudopsworks"
      organization_unit = "operations"
      environment_type  = "prod"
      environment_name  = "shared"
    }

    secrets_manager_store = true

    policies = [
      {
        name = "AdministratorAccessCustom"
        statements = [
          {
            effect    = "Allow"
            actions   = ["*"]
            resources = ["*"]
          }
        ]
      }
    ]

    groups = [
      {
        name        = "admins"
        policy_refs = ["AdministratorAccessCustom"]
      }
    ]

    users = [
      {
        name   = "admin.user"
        groups = ["admins"]
        console_access = {
          enabled = true
          password_reset_required = true
        }
        access_keys = [
          {
            name = "primary"
          }
        ]
      }
    ]
  }
  ```

quickstart: |-
  1.  **Install Terragrunt**: Ensure you have Terragrunt and Terraform installed.
  2.  **Create `terragrunt.hcl`**: Use the example above to create your configuration.
  3.  **Configure AWS Credentials**: Set up your AWS environment variables or profile.
  4.  **Initialize and Apply**:
      ```bash
      terragrunt init
      terragrunt apply
      ```
  5.  **Verify**: Check the AWS Console for the created users, groups, and policies. If `secrets_manager_store` was enabled, find the credentials in AWS Secrets Manager.

include:
  - "docs/targets.md"
  - "docs/terraform.md"

contributors:
  - name: "Cristian Beraha"
    github: "berahac"